# 接口文档

## 概述

本文档定义了后端 API 接口规范。所有外部调用必须走 `/api/v2/*` 路径。

## 统一响应规范

### 成功响应

```json
{
  "code": 0,
  "message": "ok",
  "data": { ... }
}
```

### 失败响应

```json
{
  "code": 40001,
  "message": "错误描述文案",
  "data": null
}
```

### 状态码说明

| 状态码 | 说明 |
|--------|------|
| `0` | 成功 |
| `40100` | 未登录/登录过期 |
| `40300` | 无权限执行此操作 |
| `40400` | 资源不存在 |
| `41000` | 接口已下线 (V1 API) |
| `50000` | 服务器内部错误 |
| `50300` | 数据库绑定失效 |

---

## 认证模块

**基础路径**: `/api/v2/auth`

### 登录

- **POST** `/login`
- 参数: `{ email, password }` (password 为前端 MD5)
- 返回: `data: { token, expiresAt, user: { userId, email, ... } }`

### 注册

- **POST** `/register`

### 获取当前用户信息

- **GET** `/me` (需要 Authorization 头)

### 更新资料

- **PUT** `/profile`

### 忘记密码

- **POST** `/forgot-password` (发送重置邮件)

### 重置密码

- **POST** `/reset-password`

---

## 行程模块

**基础路径**: `/api/v2/trips`

### 行程列表

- **GET** `/`
- 支持分页 `limit/offset` 与 `q` 搜索

### 创建行程

- **POST** `/`

### 行程详情

- **GET** `/:id`
- 支持 `template=card|detail|edit` 字段筛选

### 更新行程

- **PUT** `/:id`

### 删除行程

- **DELETE** `/:id` (逻辑删除)

### 获取行程完成度

- **GET** `/:id/progress`

### 设置可见性

- **PUT** `/:id/visibility`
- 参数: `private|public|link`

---

## 日程模块

### 日程精简读

- **GET** `/api/v2/schedule?tripId=...`
- 支持 Schema 筛选

### 创建日程日

- **POST** `/api/v2/trips/:id/days`

### 新增事件

- **POST** `/api/v2/trips/:id/days/:dayId/events`
- 支持单条或 `{events:[]}` 批量

### 更新单条事件

- **PUT** `/api/v2/trips/:id/events/:eventId`
- 包含 activeOptionIndex

### 删除单条事件

- **DELETE** `/api/v2/trips/:id/events/:eventId`

### 批量删除事件

- **DELETE** `/api/v2/trips/:id/events`
- 参数: `{ eventIds: [] }`

### 重排事件顺序

- **PUT** `/api/v2/trips/:id/days/:dayId/reorder`
- 参数: `{ order: [eventId...] }`

---

## 扩展资源

### 关联地点管理

- **GET/PUT** `/api/v2/trips/:id/locations`

### 两点间距离管理

- **GET/PUT** `/api/v2/trips/:id/routes`

### 验证分享链接

- **GET** `/api/v2/shares/:token`

### 撤销分享

- **DELETE** `/api/v2/shares/:id`

### 查询导出任务状态

- **GET** `/api/v2/exports/:id`

---

## 开发建议

1. **鉴权**: 所有需要登录的接口需携带 `Authorization: Bearer <token>` Header
2. **CORS**: 生产环境可通过环境变量 `ALLOWED_ORIGINS` 配置白名单域名
3. **前端拦截器**: 统一判断 `res.code === 0`，若不为 0 则抛出异常并由拦截器统一进行 Toast 提示
