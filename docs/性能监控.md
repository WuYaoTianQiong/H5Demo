# 性能监控指南

## 概述

项目已集成完整的性能监控系统，包括：

1. **HTTP 请求耗时监控** - 基于拦截器自动记录
2. **业务层 API 监控** - 基于 performance-monitor 工具
3. **页面加载监控** - 自动监控页面生命周期
4. **组件渲染监控** - 手动标记组件渲染时间

---

## 一、HTTP 请求耗时监控（自动）

### 日志输出示例

每个 HTTP 请求会自动打印如下日志：

```
[HTTP Request] GET /api/trips | ID: GET_/api/trips_1738312345678_abc123
[HTTP Timing][DEBUG] GET /api/trips | 状态: 200 | 耗时: 156ms
```

### 耗时分级

| 耗时 | 级别 | 说明 |
|------|------|------|
| < 500ms | DEBUG | 正常 |
| 500ms - 1s | INFO | 一般 |
| 1s - 3s | WARN | 较慢 |
| > 3s | ERROR | 严重慢 |

### 查看统计报告

在浏览器控制台执行：

```javascript
printHttpTiming()

// 输出示例：
// ╔════════════════════════════════════════════════════╗
// ║              HTTP 接口耗时统计报告                  ║
// ╠════════════════════════════════════════════════════╣
// ║ 总请求数: 15                                       ║
// ║ 平均耗时: 234ms                                    ║
// ║ 最大耗时: 1567ms                                   ║
// ║ 最小耗时: 45ms                                    ║
// ╚════════════════════════════════════════════════════╝
```

---

## 二、业务层 API 监控

### 在 API 调用处使用

```javascript
import { monitorApiRequest } from '@/utils/performance-monitor.js'
import { tripApi } from '@/services/api.js'

// 方式1：使用 monitorApiRequest 包装
async function fetchTripData(tripId) {
  return monitorApiRequest(
    'tripApi.get',           // API 名称
    tripApi.get,             // API 函数
    tripId                   // 参数
  )
}

// 方式2：使用 mixin 提供的方法（推荐）
export default {
  mixins: [performanceMixin],

  methods: {
    async loadTrip() {
      const trip = await this.$monitorApi(
        'scheduleApi.fetch',
        scheduleApi.fetch,
        this.tripId
      )
      this.tripData = trip
    }
  }
}
```

### 查看业务层性能报告

```javascript
printPerformance()

// 输出示例：
// ╔════════════════════════════════════════════════════╗
// ║                   性能监控报告                      ║
// ╠════════════════════════════════════════════════════╣
// ║ API 请求统计:                                      ║
// ║   总请求数: 10                                     ║
// ║   成功: 10                                         ║
// ║   失败: 0                                          ║
// ║   平均耗时: 312ms                                  ║
// ╠════════════════════════════════════════════════════╣
// ║ 各 API 平均耗时:                                   ║
// ║  scheduleApi.updateEvent: 1200ms (5次)            ║
// ║  tripApi.list: 156ms (3次)                        ║
// ╚════════════════════════════════════════════════════╝
```

---

## 三、页面性能监控（自动）

### 引入 Mixin

```javascript
import performanceMixin from '@/mixins/performance-mixin.js'

export default {
  mixins: [performanceMixin],
  // 页面加载时会自动开始监控
  // 页面卸载时会自动记录停留时间
}
```

### 查看页面加载日志

```
[Performance] 页面 /pages/trip/trip 加载完成:
  - 总加载时间: 1234ms
  - DOM Ready: 567ms
[Performance] 页面 /pages/trip/trip 停留时间: 45678ms
```

---

## 四、组件渲染监控

### 手动标记组件渲染

```javascript
export default {
  mixins: [performanceMixin],

  data() {
    return {
      componentMonitor: null
    }
  },

  created() {
    // 开始监控组件渲染
    this.componentMonitor = this.$startComponentMonitor('TripEventCard')
  },

  mounted() {
    // 标记渲染完成
    if (this.componentMonitor) {
      this.componentMonitor.markRendered()
      // 输出: [PerformanceMixin] 组件 TripEventCard 渲染: 45ms
    }
  }
}
```

---

## 五、控制台快捷命令

| 命令 | 功能 |
|------|------|
| `printHttpTiming()` | 打印 HTTP 请求耗时统计 |
| `printPerformance()` | 打印业务层性能报告 |
| `clearPerformance()` | 清除所有性能数据 |

---

## 六、日志存储

- HTTP 请求日志：保存在内存中（`uni.$httpTimingLogs`），最多 100 条
- 业务层日志：保存在本地存储（`performance_logs`），最多 200 条

---

## 七、注意事项

1. **生产环境**：建议关闭详细的性能日志或降低日志级别
2. **性能影响**：监控本身会带来极小的性能开销（< 1ms）
3. **数据安全**：性能日志中不包含敏感数据（如 token、密码等）
