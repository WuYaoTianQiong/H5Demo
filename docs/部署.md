# 旅行助手 - Cloudflare 部署指南

本文档指导你将旅行助手应用部署到 Cloudflare Pages。

---

## 目录

1. [前置要求](#前置要求)
2. [第一步：创建 D1 数据库](#第一步创建-d1-数据库)
3. [第二步：创建 Pages 项目](#第二步创建-pages-项目)
4. [第三步：配置环境变量](#第三步配置环境变量)
5. [第四步：配置 D1 数据库绑定](#第四步配置-d1-数据库绑定)
6. [第五步：部署验证](#第五步部署验证)
7. [本地开发](#本地开发)
8. [常见问题](#常见问题)

---

## 前置要求

- Cloudflare 账号（免费套餐即可）
- Git 仓库（GitHub / GitLab / Bitbucket）
- Resend 账号（用于邮件服务）
- 高德地图开发者账号

---

## 第一步：创建 D1 数据库

### 1. 创建数据库

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)
2. 进入 **Workers & Pages** → **D1 SQL Database**
3. 点击 **Create database**
4. 输入数据库名称：`travel`
5. 点击 **Create**

### 2. 记录数据库 ID

创建完成后，记录 **Database ID**，格式类似：

```
5f772248-0acc-49ec-8720-f9d32eab4433
```

### 3. 初始化数据库表

1. 在 D1 控制台点击刚创建的数据库
2. 进入 **Console** 标签页
3. 复制 `functions/database/sql/schema.sql` 文件内容
4. 粘贴到控制台并执行

---

## 第二步：创建 Pages 项目

### 1. 创建项目

1. 进入 **Workers & Pages** → **Create**
2. 选择 **Pages** 标签
3. 点击 **Connect to Git**
4. 选择你的 Git 仓库
5. 点击 **Begin setup**

### 2. 配置构建设置

| 配置项                     | 值                     |
| -------------------------- | ---------------------- |
| **Production branch**      | `main`（或你的主分支） |
| **Build command**          | `npm run build`        |
| **Build output directory** | `dist`                 |

### 3. 点击 **Save and Deploy**

首次部署可能会失败（因为环境变量还未配置），这是正常的。

---

## 第三步：配置环境变量

进入 **Pages 项目** → **Settings** → **Environment variables**

### 必需配置

添加以下环境变量：

| 变量名               | 说明                                 | 示例值                                |
| -------------------- | ------------------------------------ | ------------------------------------- |
| `JWT_SECRET`         | JWT 签名密钥（至少 32 位随机字符串） | `your-random-secret-key-32-chars-min` |
| `EMAIL_API_KEY`      | Resend API Key                       | `re_xxxxxxxxxxxx`                     |
| `VITE_AMAP_KEY`      | 高德地图 JSAPI Key                   | `6fb5b6aa...`                         |
| `VITE_AMAP_SECURITY` | 高德地图安全密钥                     | `e559dc44...`                         |
| `APP_URL`            | 应用前端地址                         | `https://your-project.pages.dev`      |
| `API_URL`            | API 地址                             | `https://your-project.pages.dev`      |

### 可选配置

| 变量名            | 说明         | 默认值                   |
| ----------------- | ------------ | ------------------------ |
| `EMAIL_SERVICE`   | 邮件服务类型 | `resend`                 |
| `EMAIL_FROM`      | 发件人邮箱   | `notice@your-domain.com` |
| `EMAIL_FROM_NAME` | 发件人名称   | `旅行助手`               |
| `JWT_EXPIRES_IN`  | Token 有效期 | `7d`                     |
| `NODE_ENV`        | 运行环境     | `production`             |

### 配置范围

- **Production**：生产环境变量
- **Preview**：预览环境变量（可选，用于测试分支）

---

## 第四步：配置 D1 数据库绑定

进入 **Pages 项目** → **Settings** → **Functions**

在 **D1 database bindings** 部分：

| 变量名称 | 数据库                         |
| -------- | ------------------------------ |
| `DB`     | `travel`（选择你创建的数据库） |

---

## 第五步：部署验证

### 1. 触发部署

- 推送代码到主分支会自动触发部署
- 或在 Pages 后台点击 **Deployments** → **Retry deployment**

### 2. 检查部署状态

1. 进入 **Deployments** 标签页
2. 查看最新部署的构建日志
3. 确认状态为 **Success**

### 3. 测试应用

访问你的 Pages 域名（如 `https://your-project.pages.dev`）：

1. 打开首页，确认页面正常加载
2. 测试注册/登录功能
3. 测试创建行程功能

### 4. 测试 API

```bash
# 测试公开 API
curl https://your-project.pages.dev/api/v2/trips

# 测试认证 API（需要替换 token）
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-project.pages.dev/api/v2/trips
```

---

## 本地开发

### 方式一：使用启动脚本

双击 `start.bat` 文件，自动启动前后端服务。

### 方式二：命令行启动

```bash
# 安装依赖
npm install

# 启动开发服务器（前端 + 后端）
npm run dev
```

- 前端地址：http://localhost:8080
- 后端地址：http://localhost:8787

### 本地环境变量

在项目根目录创建 `.dev.vars` 文件：

```bash
# JWT 配置
JWT_SECRET=your-local-secret-key-32-characters

# 高德地图
VITE_AMAP_KEY=your-amap-key
VITE_AMAP_SECURITY=your-amap-security

# 邮件服务
EMAIL_SERVICE=resend
EMAIL_API_KEY=re_your-api-key
EMAIL_FROM=notice@your-domain.com

# 应用配置
APP_URL=http://localhost:8080
API_URL=http://localhost:8787
NODE_ENV=development
```

> ⚠️ `.dev.vars` 已添加到 `.gitignore`，不会被提交到仓库。

---

## 常见问题

### Q: 部署后页面空白？

检查浏览器控制台错误：

- 确认 `VITE_AMAP_KEY` 已正确配置
- 确认 `APP_URL` 和 `API_URL` 配置正确

### Q: API 返回 500 错误？

1. 检查 D1 数据库绑定是否正确
2. 检查数据库表是否已初始化
3. 查看 Pages 后台的 Functions 日志

### Q: 登录/注册失败？

1. 确认 `JWT_SECRET` 已配置且长度 ≥ 32 位
2. 确认 `EMAIL_API_KEY` 有效
3. 检查邮件服务是否正常

### Q: 地图无法显示？

1. 确认高德地图 Key 配置正确
2. 确认 Key 的域名白名单包含你的 Pages 域名

### Q: 如何查看后端日志？

1. 进入 Pages 项目
2. 点击 **Logs** → **Begin log stream**
3. 实时查看请求日志

---

## 安全检查清单

部署前确认：

- [ ] `.dev.vars` 已添加到 `.gitignore`
- [ ] 敏感密钥未硬编码在代码中
- [ ] Cloudflare Pages 环境变量已配置
- [ ] D1 数据库绑定已设置
- [ ] 高德地图 Key 域名白名单已配置

---

## 密钥获取指南

### Resend API Key

1. 访问 https://resend.com/api-keys
2. 创建新的 API Key
3. 复制 Key 到环境变量 `EMAIL_API_KEY`

### 高德地图 Key

1. 访问 https://console.amap.com/
2. 创建应用 → 添加 Key
3. 选择「Web端(JS API)」
4. 配置域名白名单
5. 复制 Key 到 `VITE_AMAP_KEY`
6. 复制安全密钥到 `VITE_AMAP_SECURITY`

### JWT Secret

生成随机密钥（推荐 32 位以上）：

```bash
# macOS/Linux
openssl rand -base64 32

# 或使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## 自定义域名（可选）

1. 进入 Pages 项目 → **Custom domains**
2. 点击 **Set up a custom domain**
3. 输入你的域名
4. 按提示添加 DNS 记录
5. 等待 SSL 证书自动签发

配置完成后更新环境变量：

- `APP_URL=https://your-domain.com`
- `API_URL=https://your-domain.com`
